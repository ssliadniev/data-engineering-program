name: CI/CD Blue-Green Deployment

on:
  workflow_dispatch:

  push:
    branches: [ "dev" ]

permissions:
  contents: write

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GKE_CLUSTER: ${{ secrets.GKE_CLUSTER_NAME }}
  GKE_ZONE: ${{ secrets.GKE_ZONE }}
  IMAGE_NAME: hello-gitops
  WORK_DIR: dev-dataops/homework-4

jobs:
  ci-build-test:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./dev-dataops/homework-4

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          pip install -r app/requirements.txt

      - name: Run Tests
        run: |
          cd app
          pytest test_hello.py

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Configure Docker
        run: gcloud auth configure-docker us-central1-docker.pkg.dev

      - name: Build and Push Docker Image
        run: |
          IMAGE_TAG=${{ github.sha }}
          docker build -t us-central1-docker.pkg.dev/$PROJECT_ID/homework-4/$IMAGE_NAME:$IMAGE_TAG app/
          docker push us-central1-docker.pkg.dev/$PROJECT_ID/homework-4/$IMAGE_NAME:$IMAGE_TAG

  cd-blue-green:
    needs: ci-build-test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./dev-dataops/homework-4

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Kustomize
        uses: imranismail/setup-kustomize@v2

      - name: Authenticate to GKE
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Get GKE Credentials
        uses: google-github-actions/get-gke-credentials@v1
        with:
          cluster_name: ${{ env.GKE_CLUSTER }}
          location: ${{ env.GKE_ZONE }}

      - name: Execute Blue/Green Deployment
        run: |
          echo "Starting Blue/Green Deployment..."

          CURRENT_COLOR=$(kubectl get service hello-gitops -o=jsonpath='{.spec.selector.color}' 2>/dev/null || echo "none")

          if [ "$CURRENT_COLOR" == "blue" ]; then
            NEW_COLOR="green"
            OLD_COLOR="blue"
          else
            NEW_COLOR="blue"
            OLD_COLOR="green"
          fi

          echo "Current color: $CURRENT_COLOR"
          echo "Deploying to: $NEW_COLOR"

          sed "s/name: hello-gitops/name: hello-gitops-$NEW_COLOR/" k8s/deployment.yaml > k8s/deployment-active.yaml
          
          cat <<EOF > k8s/kustomization.yaml
          apiVersion: kustomize.config.k8s.io/v1beta1
          kind: Kustomization
          resources:
          - deployment-active.yaml
          - service.yaml
          - ingress.yaml
          namespace: hello-gitops
          commonLabels:
            color: $NEW_COLOR
          images:
          - name: hello-gitops
            newName: us-central1-docker.pkg.dev/$PROJECT_ID/homework-4/$IMAGE_NAME
            newTag: ${{ github.sha }}
          EOF

          kubectl apply -k k8s/

          # Wait for readiness
          echo "Waiting for deployment hello-gitops-$NEW_COLOR to be ready..."
          kubectl rollout status deployment/hello-gitops-$NEW_COLOR -n hello-gitops --timeout=60s

          echo "Switching traffic to $NEW_COLOR..."
          kubectl patch service hello-gitops -n hello-gitops -p "{\"spec\":{\"selector\":{\"color\":\"$NEW_COLOR\"}}}"

          if kubectl get deployment hello-gitops-$OLD_COLOR -n hello-gitops; then
              echo "Deleting old deployment: hello-gitops-$OLD_COLOR"
              kubectl delete deployment hello-gitops-$OLD_COLOR -n hello-gitops
          else
              echo "Old deployment not found (first run?), skipping delete."
          fi

      - name: Commit State to Git
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          
          git add k8s/kustomization.yaml k8s/deployment-active.yaml

          git commit -m "Deploy: Switched to ${{ github.sha }} ($NEW_COLOR) [skip ci]"
          git push
